{% load static %}
{% load bootstrap4 %}
<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <title>Ilustrações</title>
    <link rel="icon" type="image/x-icon" href="{% static 'planilha/images/ico.png' %}">
    {% bootstrap_css %}

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <link rel="stylesheet" href="{% static 'planilha/css/estilos.css' %}">
    
    <style>
        /* Regras para Colapso Horizontal */
        .collapse-horizontal {
            overflow: hidden;
            width: 0 !important;
            transition: width 0.3s ease;
            height: auto !important;
        }
        .collapse-horizontal.show {
            width: 350px !important; /* Largura do Painel de Filtros */
        }
        .collapsing-horizontal {
            height: auto !important;
            transition: width 0.3s ease;
            width: 0 !important;
        }
    
        .sticky-filter-wrapper {
            position: -webkit-sticky;
            position: sticky;
            top: 60px;
        }
    
        /* CSS para fixar a primeira coluna (Retranca) */
        .table-responsive .fixed-column {
            position: sticky;
            left: 0;
            z-index: 10;
            background-color: #f8f9fa;
            border-right: 1px solid #dee2e6;
        }
    
        #tabela_de_ilustracoes thead th.fixed-column {
            z-index: 11;
        }
        #tabela_de_ilustracoes thead.sticky-top th.fixed-column {
            background-color: #e9ecef;
        }
    
        /* RESET base (evita 'fantasmas') */
        .row.no-gutters #filtroWrapper,
        .row.no-gutters #tabelaWrapper {
            padding-left: 0 !important;
            padding-right: 0 !important;
        }
    
        /* Aplicar gutter somente quando você explicitamente quiser (mantido para referência) */
        .row.no-gutters #filtroWrapper.col-lg-3,
        .row.no-gutters #filtroWrapper.col-md-4 {
            /* deixe em 0 por padrão; o JS decide quando adicionar espaço */
            padding-right: 0 !important;
        }
    
        .row.no-gutters #tabelaWrapper.col-lg-9,
        .row.no-gutters #tabelaWrapper.col-md-8 {
            padding-left: 0 !important;
        }
    
        /* utilitário para casos JS (se precisar marcar) */
        .row.no-gutters #filtroWrapper.collapsed-no-padding,
        .row.no-gutters #tabelaWrapper.collapsed-no-padding {
            padding-left: 0 !important;
            padding-right: 0 !important;
        }
    
        /* Fim do bloco de estilos relevantes ao gutter */

        /* 1. Aplica o estilo ao container pai que envolve o label e o input do filtro */
        p:has(#id_lote_preenchido) {
            display: flex; 
            align-items: center; 
            gap: 8px; 
            margin: 0; 

            /* NOVO: Adiciona um preenchimento à esquerda para afastar da borda da tela */
            padding-left: 20px; 
        }

        /* 2. Ajuste fino para o checkbox (input) */
        #id_lote_preenchido {
            width: auto !important; 
            flex-shrink: 0; 
            margin-top: 0 !important; 
        }

        /* 3. Ajuste fino para o Label */
        label[for="id_lote_preenchido"] {
            white-space: nowrap; 
            line-height: normal; 
            margin-bottom: 5px; 
        }
    </style>
    
    
</head>

<body>

    {% include '_nav.html' %}


    <div class="container-fluid mt-4">
        
        {% if messages %}
            <div class="container-fluid mt-4">
                {% for message in messages %}
                    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                        {{ message|safe }}
                        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
        
        <h1>
            {% if ativo == True %}
            Ilustrações
            {% else %}
            Ilustrações excluídas
            {% endif %}
        </h1>

        <p>
            <a href="{% url 'nova_ilustracao' %}" class="btn btn-outline-primary my-2 my-sm-0 mr-2 mb-1" role="button">
                + ilustração
            </a>
            {% if ativo %}
            <a href="{% url 'ilustras_excluidas' %}" class="btn btn-primary mr-2 mb-1" role="button">
                Ir para ilustrações excluídas
            </a>
            {% else %}
            <a href="{% url 'ilustras' %}" class="btn btn-primary mr-2 mb-1" role="button">
                Voltar para ilustrações ativas
            </a>
            {% endif %}
            <button class="btn btn-secondary mr-2 mb-1" type="button" 
                        data-toggle="collapse" 
                        data-target="#blocoFiltros" 
                        aria-expanded="{% if filter.data %}true{% else %}false{% endif %}" 
                        aria-controls="blocoFiltros" 
                        id="btnToggleFiltros">
                        <i class="fas fa-filter"></i> 
                        <span id="labelToggleFiltros">
                            {% if filter.data %}Ocultar filtros{% else %}Exibir filtros{% endif %}
                        </span>
                    </button>
        </p>


        <div class="row flex-nowrap no-gutters">

            <div class="col-lg-3 col-md-4" id="filtroWrapper">
                
                <div class="collapse-horizontal {% if filter.data %}show{% endif %}" id="blocoFiltros">
                    <div class="sticky-filter-wrapper">
                        <div class="card shadow-sm p-3 mb-4 bg-white rounded-lg">

                            <h5 class="card-title text-xl font-bold mb-3">Filtrar ilustrações</h5>

                            <div>
                                Consulte <a href="{% url 'ajuda_regex' %}" target="_blank">aqui</a> um guia de como fazer buscas.
                                <p></p>
                            </div>

                            <form method="get">
                                {{ filter.form.as_p }}
                                <div class="d-grid gap-2">
                                    <button type="submit" class="btn btn-success w-100 mb-2">
                                        <i class="fas fa-filter"></i> Aplicar Filtros
                                    </button>
                                    {% if ativo %}
                                    <a href="{% url 'ilustras' %}" class="btn btn-outline-secondary w-100" role="button">
                                        <i class="fas fa-times"></i> Limpar filtros
                                    </a>
                                    {% else %}
                                    <a href="{% url 'ilustras_excluidas' %}" class="btn btn-outline-secondary w-100"
                                        role="button">
                                        <i class="fas fa-times"></i> Limpar filtros
                                    </a>
                                    {% endif %}
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-9 col-md-8" id="tabelaWrapper">
                
                <p class="d-flex align-items-center flex-wrap">
                    {% if filter.data %}
                        {% if ativo %}
                        <a href="{% url 'ilustras' %}" class="btn btn-outline-secondary mr-2 mb-1" role="button">
                            <i class="fas fa-times"></i> Limpar filtros
                        </a>
                        {% else %}
                        <a href="{% url 'ilustras_excluidas' %}" class="btn btn-outline-secondary mr-2 mb-1" role="button">
                            <i class="fas fa-times"></i> Limpar filtros
                        </a>
                        {% endif %}
                    {% endif %}

                </p>
                
                {% if pre_filtro_ativo %}
                <div class="alert alert-info alert-dismissible fade show" role="alert">
                    <i class="fas fa-filter me-2"></i> 
                    <strong>Pré-Filtro Ativo:</strong> Esta listagem está filtrada automaticamente pelas suas preferências de projetos/componentes/volume.
                    Você pode **modificar ou desativar** estas preferências na sua <a href="{% url 'preferencias' %}" class="alert-link">página de Preferências</a>.
                    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                {% endif %}
                <p>
                    <span>Exibindo: {{ num_linhas }} linha(s) de um total de {{num_linhas_total}}.</span>

                    <button class="btn btn-success btn-sm"
                        onclick="exportTableToCSV('tabela_de_ilustracoes', 'ilustracoes.csv')">
                        <i class="fas fa-file-csv"></i> Exportar exibição para CSV
                    </button>
                    <!-- <button class="btn btn-success btn-sm"
                        onclick="exportTable('tabela_de_ilustracoes', 'xlsx', 'ilustracoes');">
                        Exportar exibição para Excel
                    </button> -->
                    <a href="{% url 'exportar_ilustras_excel_completo' %}?{{ request.GET.urlencode }}" 
                        class="btn btn-success btn-sm" 
                        role="button">
                        <i class="fas fa-file-excel"></i> Exportar exibição para Excel
                    </a>

                    <a href="{% url 'exportar_creditos_csv' %}?{{ request.GET.urlencode }}" 
                        class="btn btn-primary btn-sm" 
                        role="button">
                        <i class="fas fa-file-csv"></i> Créditos CSV
                        </a>
                    <a href="{% url 'exportar_creditos_csv_replace' %}?{{ request.GET.urlencode }}" 
                        class="btn btn-primary btn-sm" 
                        role="button">
                        <i class="fas fa-file-csv"></i> Créditos CSV sem arquivo da editora
                        </a>

                        <a href="{% url 'import_ilustracoes_excel' %}" class="btn btn-info btn-sm">
                            <i class="fas fa-file-import"></i> Importar novas ilustrações do Excel
                            </a>
                        <a href="{% url 'upload_ilustracoes_excel' %}" class="btn btn-warning btn-sm">
                            <i class="fas fa-file-upload"></i> Importar atualizações do Excel
                            </a>
                    <a href="{% url 'exportar_csv_completo' %}" class="btn btn-success">
                            <i class="fas fa-file-csv"></i> Exportar base completa CSV
                    </a>
                </p>

                <div class="table-responsive">
                    <table class="table table-striped table-hover align-middle" id="tabela_de_ilustracoes">
                        <thead class="bg-light sticky-top">
                            <tr>
                                <th class="fixed-column">Retranca</th> 
                                <th hidden>pk</th>
                                <th {% if not preferencias_colunas.exibir_status %} hidden {% endif %}>Status</th>
                                <th {% if not preferencias_colunas.exibir_categoria %} hidden {% endif %}>Categoria</th>
                                <th {% if not preferencias_colunas.exibir_localizacao %} hidden {% endif %}>Localização</th>
                                <th {% if not preferencias_colunas.exibir_volume %} hidden {% endif %}>Volume</th>
                                <th {% if not preferencias_colunas.exibir_unidade %} hidden {% endif %}>Unidade</th>
                                <th {% if not preferencias_colunas.exibir_capitulo_secao %} hidden {% endif %}>Capítulo ou seção</th>
                                <th {% if not preferencias_colunas.exibir_pagina %} hidden {% endif %}>Página</th>
                                <th {% if not preferencias_colunas.exibir_tipo %} hidden {% endif %}>Tipo</th>
                                <th {% if not preferencias_colunas.exibir_descricao %} hidden {% endif %}>Descrição</th>
                                <th {% if not preferencias_colunas.exibir_observacao_edit_nuc %} hidden {% endif %}>Observação editorial e núcleo</th>
                                <th {% if not preferencias_colunas.exibir_lote %} hidden {% endif %}>Lote</th>
                                <th {% if not preferencias_colunas.exibir_data_liberacao_para_arte %} hidden {% endif %}>Data de liberação do lote</th>
                                <th {% if not preferencias_colunas.exibir_data_envio_pedido %} hidden {% endif %}>Data de envio do pedido</th>
                                <th {% if not preferencias_colunas.exibir_data_recebimento_rafe %} hidden {% endif %}>Data de recebimento do rafe</th>
                                <th {% if not preferencias_colunas.exibir_data_retorno_rafe %} hidden {% endif %}>Data de retorno do rafe</th>
                                <th {% if not preferencias_colunas.exibir_data_recebimento_finalizada %} hidden {% endif %}>Data de recebimento da finalizada</th>
                                <th {% if not preferencias_colunas.exibir_classificacao %} hidden {% endif %}>Classificação</th>
                                <th {% if not preferencias_colunas.exibir_credito %} hidden {% endif %}>Crédito</th>
                                <th {% if not preferencias_colunas.exibir_ilustrador %} hidden {% endif %}>Ilustrador criação</th>
                                <th {% if not preferencias_colunas.exibir_ilustrador_ajuste %} hidden {% endif %}>Ilustrador ajuste</th>
                                <th {% if not preferencias_colunas.exibir_observacao_arte %} hidden {% endif %}>Observação da arte</th>
                                <th {% if not preferencias_colunas.exibir_pagamento %} hidden {% endif %}>Pagamento</th>
                                <th {% if not preferencias_colunas.exibir_criado_por %} hidden {% endif %}>Criado por</th>
                                <th {% if not preferencias_colunas.exibir_criado_em %} hidden {% endif %}>Criado em</th>
                                <th {% if not preferencias_colunas.exibir_atualizado_por %} hidden {% endif %}>Modificado por</th>
                                <th {% if not preferencias_colunas.exibir_modificado_em %} hidden {% endif %}>Modificado em</th>
                                <th {% if not preferencias_colunas.exibir_projeto %} hidden {% endif %}>Projeto</th>
                                <th {% if not preferencias_colunas.exibir_componente %} hidden {% endif %}>Componente</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for il in filter.qs %} 
                            <tr>
                                <td title="Retranca" class="fixed-column">{{ il.retranca|default:"" }}</td>
                                <td hidden>{{ il.pk }}</td>
                                <td title="Status" {% if not preferencias_colunas.exibir_status %} hidden {% endif %}>{{ il.get_status_display|default:"" }}</td>
                                <td title="Categoria" {% if not preferencias_colunas.exibir_categoria %} hidden {% endif %}>{{ il.get_categoria_display|default:"" }}</td>
                                <td title="Localização" {% if not preferencias_colunas.exibir_localizacao %} hidden {% endif %}>{{ il.get_localizacao_display|default:"" }}</td>
                                <td title="Volume" {% if not preferencias_colunas.exibir_volume %} hidden {% endif %}>{{ il.volume|default:"" }}</td>
                                <td title="Unidade" {% if not preferencias_colunas.exibir_unidade %} hidden {% endif %}>{{ il.unidade|default:"" }}</td>
                                <td title="Capítulo ou seção" {% if not preferencias_colunas.exibir_capitulo_secao %} hidden {% endif %}>{{ il.capitulo_secao|default:"" }}</td>
                                <td title="Página" {% if not preferencias_colunas.exibir_pagina %} hidden {% endif %}>{{ il.pagina|default:"" }}</td>
                                <td title="Tipo" {% if not preferencias_colunas.exibir_tipo %} hidden {% endif %}>{{ il.get_tipo_display|default:"" }}</td>
                                <td title="Descrição" {% if not preferencias_colunas.exibir_descricao %} hidden {% endif %}>{{ il.descricao|default:"" }}</td>
                                <td title="Observação editorial e núcleo" {% if not preferencias_colunas.exibir_observacao_edit_nuc %} hidden {% endif %}>{{ il.observacao_edit_nuc|default:"" }}</td>
                                <td title="Lote" {% if not preferencias_colunas.exibir_lote %} hidden {% endif %}>{{ il.lote|default:"" }}</td>
                                <td title="Data de liberação do lote" {% if not preferencias_colunas.exibir_data_liberacao_para_arte %} hidden {% endif %}>{{ il.data_liberacao_para_arte | date:"d/m/Y"|default:"" }}</td>
                                <td title="Data de envio do pedido" {% if not preferencias_colunas.exibir_data_envio_pedido %} hidden {% endif %}>{{ il.data_envio_pedido | date:"d/m/Y"|default:"" }}</td>
                                <td title="Data de recebimento do rafe" {% if not preferencias_colunas.exibir_data_recebimento_rafe %} hidden {% endif %}>{{ il.data_recebimento_rafe | date:"d/m/Y"|default:"" }}</td>
                                <td title="Data de retorno do rafe" {% if not preferencias_colunas.exibir_data_retorno_rafe %} hidden {% endif %}>{{ il.data_retorno_rafe | date:"d/m/Y"|default:"" }}</td>
                                <td title="Data de recebimento da finalizada" {% if not preferencias_colunas.exibir_data_recebimento_finalizada %} hidden {% endif %}>{{ il.data_recebimento_finalizada | date:"d/m/Y"|default:"" }}</td>
                                <td title="Classificação" {% if not preferencias_colunas.exibir_classificacao %} hidden {% endif %}>{{ il.classificacao|default:"" }}</td>
                                <td title="Crédito" {% if not preferencias_colunas.exibir_credito %} hidden {% endif %}>{{ il.credito|default:"" }}</td>
                                <td title="Ilustrador criação" {% if not preferencias_colunas.exibir_ilustrador %} hidden {% endif %}>{{ il.ilustrador|default:"" }}</td>
                                <td title="Ilustrador ajuste" {% if not preferencias_colunas.exibir_ilustrador_ajuste %} hidden {% endif %}>{{ il.ilustrador_ajuste|default:"" }}</td>
                                <td title="Observação da arte" {% if not preferencias_colunas.exibir_observacao_arte %} hidden {% endif %}>{{ il.observacao_arte|default:"" }}</td>
                                <td title="Pagamento" {% if not preferencias_colunas.exibir_pagamento %} hidden {% endif %}>{{ il.get_pagamento_display|default:"" }}</td>
                                <td title="Criado por" {% if not preferencias_colunas.exibir_criado_por %} hidden {% endif %}>{{ il.criado_por | default:"" }}</td>
                                <td title="Criado em" {% if not preferencias_colunas.exibir_criado_em %} hidden {% endif %}>{{ il.criado_em | date:"d/m/Y"|default:"" }}</td>
                                <td title="Modificado por" {% if not preferencias_colunas.exibir_atualizado_por %} hidden {% endif %}>{{ il.atualizado_por | default:"" }}</td>
                                <td title="Modificado em" {% if not preferencias_colunas.exibir_modificado_em %} hidden {% endif %}>{{ il.modificado_em | date:"d/m/Y"|default:"" }}</td>
                                <td title="Projeto" {% if not preferencias_colunas.exibir_projeto %} hidden {% endif %}>{{ il.projeto|default:"" }}</td>
                                <td title="Componente" {% if not preferencias_colunas.exibir_componente %} hidden {% endif %}>{{ il.componente|default:"" }}</td>
                                <td class="text-nowrap">
                                    <a href="{% url 'detalhe_ilustracao' il.pk %}" class="btn btn-sm btn-info" target="_blank"
                                        title="Use Ctrl + Clique para abrir em nova janela">
                                        <i class="fas fa-edit"></i> Editar
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                            </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="d-block" style="height: 300px;"></div>


        {% bootstrap_javascript jquery='full' %}

        <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/tableexport@5.2.0/dist/js/tableexport.min.js"></script>
        <script src="{% static 'planilha/js/scripts.js' %}"></script>

        <script>
            (function() {
                const blocoFiltros = document.getElementById('blocoFiltros');
                const filtroWrapper = document.getElementById('filtroWrapper');
                const tabelaWrapper = document.getElementById('tabelaWrapper');
            
                if (!blocoFiltros || !filtroWrapper || !tabelaWrapper) return;
            
                function painelAberto() {
                    filtroWrapper.classList.remove('d-none');
                    filtroWrapper.classList.add('col-lg-3', 'col-md-4');
            
                    tabelaWrapper.classList.remove('col-12');
                    tabelaWrapper.classList.add('col-lg-9', 'col-md-8');
            
                    // remove qualquer padding inline que tenhamos usado para "fechado"
                    filtroWrapper.style.paddingRight = '';
                    tabelaWrapper.style.paddingLeft = '';
                }
            
                function painelFechado() {
                    filtroWrapper.classList.add('d-none');
                    filtroWrapper.classList.remove('col-lg-3', 'col-md-4');
            
                    tabelaWrapper.classList.remove('col-lg-9', 'col-md-8');
                    tabelaWrapper.classList.add('col-12');
            
                    // limpa inline styles de gutter
                    filtroWrapper.style.paddingRight = '';
                    tabelaWrapper.style.paddingLeft = '';
                }
            
                function aplicarEstadoAtual() {
                    // usa a presença da classe 'show' no elemento collapse para decidir
                    if (blocoFiltros.classList.contains('show')) {
                        painelAberto();
                    } else {
                        painelFechado();
                    }
                }
            
                // 1) Bind em eventos bootstrap (quando disponíveis)
                // usamos try/catch para não falhar se bootstrap não estiver presente
                try {
                    blocoFiltros.addEventListener('shown.bs.collapse', function(){ painelAberto(); });
                    blocoFiltros.addEventListener('hidden.bs.collapse', function(){ painelFechado(); });
                } catch (e) {
                    // nada — fallback com MutationObserver abaixo
                }
            
                // 2) MutationObserver: observa mudanças no atributo 'class' do bloco de filtros
                const mo = new MutationObserver(function(mutations) {
                    for (const m of mutations) {
                        if (m.type === 'attributes' && m.attributeName === 'class') {
                            aplicarEstadoAtual();
                            break;
                        }
                    }
                });
                mo.observe(blocoFiltros, { attributes: true, attributeFilter: ['class'] });
            
                // 3) Verificações iniciais com pequenos delays para cobrir diferentes ordens de execução
                // (bootstrap pode inicializar e disparar eventos em momentos diferentes)
                document.addEventListener('DOMContentLoaded', function() {
                    // chamada imediata
                    aplicarEstadoAtual();
                    // reforços para cobrir casos onde bootstrap/jQuery terminam init depois
                    setTimeout(aplicarEstadoAtual, 50);
                    setTimeout(aplicarEstadoAtual, 200);
                    setTimeout(aplicarEstadoAtual, 600);
                });
            
                // 4) proteção: caso outro script remova o element do DOM e o reinsira,
                // re-aplicar estado ao reconectar (opcional)
                // (observa mudanças no corpo para reconexões do blocoFiltros)
                const bodyMo = new MutationObserver(function(mutations) {
                    for (const m of mutations) {
                        // se blocoFiltros estiver no DOM, checamos estado
                        if (document.contains(blocoFiltros)) {
                            aplicarEstadoAtual();
                            break;
                        }
                    }
                });
                bodyMo.observe(document.body, { childList: true, subtree: true });
            
            })();
            </script>
            

            

        
        
            
            

</body>

</html>